# Telegraf pulls uplinks from TTN MQTT and writes them to InfluxDB.
[global_tags]
  source = "ttn"

[agent]
  interval = "10s"
  flush_interval = "10s"
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  omit_hostname = true

[[inputs.mqtt_consumer]]
  servers = ["tcp://${TTN_REGION}.cloud.thethings.network:1883"]
  topics = ["v3/${TTN_APP_ID}@${TTN_REGION}/devices/+/up"]
  username = "${TTN_APP_ID}"
  password = "${TTN_API_KEY}"
  qos = 0
  connection_timeout = "30s"
  data_format = "json"
  tag_keys = ["end_device_ids.device_id", "end_device_ids.application_ids.application_id", "end_device_ids.dev_eui"]
  name_override = "ttn_uplink"
  json_time_key = "received_at"
  json_time_format = "2006-01-02T15:04:05.999Z07:00"

[[processors.parser]]
  parse_fields = ["uplink_message.decoded_payload"]
  data_format = "json"

[[processors.filter]]
  fieldinclude = ["event", "confidence", "lux"]

[[processors.rename]]
  [[processors.rename.replace]]
    field = "event"
    dest = "event_type"

[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "${INFLUXDB_TOKEN}"
  organization = "${INFLUXDB_ORG}"
  bucket = "${INFLUXDB_BUCKET}"
  timeout = "15s"
